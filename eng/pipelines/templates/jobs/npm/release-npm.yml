parameters:
- name: ServerName
  type: string
- name: IncludeNative
  type: boolean
- name: DependsOn
  type: object

jobs:
- deployment: PublishNpm
  displayName: "Publish to npmjs.com"
  dependsOn: ${{ parameters.DependsOn }}
  condition: and(succeeded(), ne(variables['Skip.PublishPackage'], 'true'))
  templateContext:
    type: releaseJob
    isProduction: true
    inputs:
    - input: pipelineArtifact
      artifactName: npm_$(PipelineArtifactName)_packed
      targetPath: $(Pipeline.Workspace)/drop
  environment: package-publish
  timeoutInMinutes: 120
  pool:
    name: azsdk-pool
    image: ubuntu-24.04
    os: linux
  strategy:
    runOnce:
      deploy:
        steps:
        - pwsh: |
            $path = '$(Pipeline.Workspace)/drop/${{ parameters.ServerName }}/platform'
            Write-Host "Contents of $path`:"
            Get-ChildItem $path -Recurse

            $path = '$(Pipeline.Workspace)/drop/${{ parameters.ServerName }}/wrapper'
            Write-Host "`n`nContents of $path`:"
            Get-ChildItem $path -Recurse

        - task: EsrpRelease@9
          displayName: Publish platform packages to npmjs.com
          inputs:
            ConnectedServiceName: 'Azure SDK PME Managed Identity'
            ClientId: '5f81938c-2544-4f1f-9251-dd9de5b8a81b'
            DomainTenantId: '975f013f-7f24-47e8-a7d3-abc4752bf346'
            UseManagedIdentity: true
            KeyVaultName: 'kv-azuresdk-codesign'
            SignCertName: 'azure-sdk-esrp-release-certificate'
            Intent: 'PackageDistribution'
            ContentType: 'npm'
            FolderLocation: $(Pipeline.Workspace)/drop/${{ parameters.ServerName }}/platform
            Owners: ${{ coalesce(variables['Build.RequestedForEmail'], 'azuresdk@microsoft.com') }}
            Approvers: ${{ coalesce(variables['Build.RequestedForEmail'], 'azuresdk@microsoft.com') }}
            ServiceEndpointUrl: 'https://api.esrp.microsoft.com'
            MainPublisher: 'ESRPRELPACMANTEST'
            ProductState: latest
        - task: EsrpRelease@9
          displayName: Publish wrapper package to npmjs.com
          inputs:
            ConnectedServiceName: 'Azure SDK PME Managed Identity'
            ClientId: '5f81938c-2544-4f1f-9251-dd9de5b8a81b'
            DomainTenantId: '975f013f-7f24-47e8-a7d3-abc4752bf346'
            UseManagedIdentity: true
            KeyVaultName: 'kv-azuresdk-codesign'
            SignCertName: 'azure-sdk-esrp-release-certificate'
            Intent: 'PackageDistribution'
            ContentType: 'npm'
            FolderLocation: $(Pipeline.Workspace)/drop/${{ parameters.ServerName }}/wrapper
            Owners: ${{ coalesce(variables['Build.RequestedForEmail'], 'azuresdk@microsoft.com') }}
            Approvers: ${{ coalesce(variables['Build.RequestedForEmail'], 'azuresdk@microsoft.com') }}
            ServiceEndpointUrl: 'https://api.esrp.microsoft.com'
            MainPublisher: 'ESRPRELPACMANTEST'
            ProductState: latest
        - ${{ if eq(parameters.IncludeNative, true) }}:
          - task: EsrpRelease@9
            displayName: Publish native platform packages to npmjs.com
            inputs:
              ConnectedServiceName: 'Azure SDK PME Managed Identity'
              ClientId: '5f81938c-2544-4f1f-9251-dd9de5b8a81b'
              DomainTenantId: '975f013f-7f24-47e8-a7d3-abc4752bf346'
              UseManagedIdentity: true
              KeyVaultName: 'kv-azuresdk-codesign'
              SignCertName: 'azure-sdk-esrp-release-certificate'
              Intent: 'PackageDistribution'
              ContentType: 'npm'
              FolderLocation: $(Pipeline.Workspace)/drop/${{ parameters.ServerName }}-native/platform
              Owners: ${{ coalesce(variables['Build.RequestedForEmail'], 'azuresdk@microsoft.com') }}
              Approvers: ${{ coalesce(variables['Build.RequestedForEmail'], 'azuresdk@microsoft.com') }}
              ServiceEndpointUrl: 'https://api.esrp.microsoft.com'
              MainPublisher: 'ESRPRELPACMANTEST'
              ProductState: latest
          - task: EsrpRelease@9
            displayName: Publish native wrapper package to npmjs.com
            inputs:
              ConnectedServiceName: 'Azure SDK PME Managed Identity'
              ClientId: '5f81938c-2544-4f1f-9251-dd9de5b8a81b'
              DomainTenantId: '975f013f-7f24-47e8-a7d3-abc4752bf346'
              UseManagedIdentity: true
              KeyVaultName: 'kv-azuresdk-codesign'
              SignCertName: 'azure-sdk-esrp-release-certificate'
              Intent: 'PackageDistribution'
              ContentType: 'npm'
              FolderLocation: $(Pipeline.Workspace)/drop/${{ parameters.ServerName }}-native/wrapper
              Owners: ${{ coalesce(variables['Build.RequestedForEmail'], 'azuresdk@microsoft.com') }}
              Approvers: ${{ coalesce(variables['Build.RequestedForEmail'], 'azuresdk@microsoft.com') }}
              ServiceEndpointUrl: 'https://api.esrp.microsoft.com'
              MainPublisher: 'ESRPRELPACMANTEST'
              ProductState: latest
        - template: /eng/pipelines/templates/steps/publish-to-dev-feed.yml
          parameters:
            PathToArtifacts: $(Pipeline.Workspace)/drop
            Registry: https://pkgs.dev.azure.com/azure-sdk/public/_packaging/azure-sdk-for-js/npm/registry/
            Tag: latest
